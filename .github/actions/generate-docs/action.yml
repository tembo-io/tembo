name: Generate and Deploy Documentation
inputs:
  repository:
    description: 'The tembo repository'
    required: true
  ssh_key:
    description: 'The SSH key for the repository'
    required: true
  branch:
    description: 'The branch to update'
    required: true
  version:
    description: 'The version to use for updating'
    required: true
  clone_into:
    description: 'The directory to clone the argocd repo into'
    required: true
on:
  push:
    paths:
      - 'tembo-cli/**'
    branches:
      - main
  pull_request:
    paths:
      - 'tembo-cli/**'
    branches:
      - main
      - develop
      - feature/*

jobs:
  generate_and_deploy_docs:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ssh-key: ${{ secrets.SERVICE_USER_GITHUB_SSH_KEY }}
          clone-into: ${{ inputs.clone_into }}
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Generate Documentation
        run: |
          cd ${{ inputs.repository }}
          cargo run -- --markdown-help > command-reference.md

      - name: Push Documentation to Website Repository
        run: |
          set -xe
          cd ${{ inputs.clone_into }}
          git config --global user.name "coredb-service-user"
          git config --global user.email "admin+github@coredb.io"
          git fetch origin ${{ inputs.branch }} && git checkout ${{ inputs.branch }} || git checkout -b ${{ inputs.branch }}

          # Ensure the target directory exists in the desired branch
          git fetch
          git checkout docs-updates
          mkdir -p src/content/docs/development/cli

          # Copy the documentation over
          cp ../command-reference.md src/content/docs/development/cli

          # Add, commit, and push changes
          git add src/content/docs/development/cli/command-reference.md
          git commit -m "Update command reference documentation"
          git push